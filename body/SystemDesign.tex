\chapter{System Design}
%System design with system diagram



\begin{figure}[!htb]
	\centering
	\includegraphics[width=\textwidth]{body/fig/Fulldrawio}
	\caption{Hardware and Interface Overview \\(Base station on the left and Satellite station on the right) }
	\label{fig:fulldrawio}
\end{figure}

\section{Hardware Overview}
\subsection{Microcontroller}
An essential part of this project is the microcontroller, since it contains and controls many of the aspects needed for the project to work.
Choosing a microcontroller comes down to it's features. For this project the features considered were:
\begin{itemize}
	\item Speed
	\item Communication capabilities
	\item Expandability / IO
	\item Storage
	\item Power draw
	\item Size
	\item Cost
\end{itemize}

\noindent
A few common microcontroller boards available at the time of writing are compared in the table below along with their respective specifications:



% \usepackage{tabularray}
\begin{table}[!htb]
	\centering

	\resizebox{\linewidth}{!}{%
		\begin{tblr}{
				cell{3}{3} = {c},
				cell{3}{4} = {c},
				cell{3}{5} = {c},
				cell{4}{3} = {c},
				cell{4}{4} = {c},
				cell{4}{5} = {c},
				cell{5}{3} = {c},
				cell{5}{4} = {c},
				cell{5}{5} = {c},
				cell{6}{3} = {c},
				cell{6}{4} = {c},
				cell{6}{5} = {c},
				cell{7}{3} = {c},
				cell{7}{4} = {c},
				cell{7}{5} = {c},
				cell{8}{3} = {c},
				cell{8}{4} = {c},
				cell{8}{5} = {c},
				vline{1,6} = {1-4,9-12}{},
				vline{1-2,6} = {5-8}{},
				hline{1-4,9-13} = {-}{},
				hline{5} = {1,3-5}{},
				hline{6-8} = {3-5}{},
			}
			&          & ESP32-S2 lolin  mini                                   & ESP8266 NodeMCU                                        & Raspberry Pi Zero W  \\
			Speed               &          & {Tensilica Xtensa LX7 32 bit \\  Single-Core @ 240Mhz} & {Tensilica LX106 32 bit \\ @ 80 MHz (up to   160 MHz)} & BCM2835 1GHz         \\
			Communication       & Wifi     & 802.11b/g/n                                            & 802.11b/g/n max 65mbps                                 & 802.11b/g/n          \\
			Expandability  / IO & I2C      & 2                                                      & 1                                                      & 2                    \\
			& ADC      & 20 x 12bit                                             & 1 x 10 bit                                             & 8 x 17 bit           \\
			& CAN/TWAI & X                                                      &                                                        & Needs HAT            \\
			& GPIO     & 43                                                     & 17                                                     & 40                   \\
			& UART     & X                                                      & X                                                      & X                    \\
			Storage             &          & Micro SD and USB OTG                                   & Needs module                                           & Micro SD and USB OTG \\
			Power draw          &          & 190mA peak when sending WiFi                           & 250mA peak                                             & 260mA at idle        \\
			Size                &          & 34.3*25.4mm                                            & 49*26mm                                                & 60*30mm              \\
			Cost                &          & R99                                                    & R94                                                    & R320.85              
		\end{tblr}
	}
	\caption{Microcontroller option and Specifications}
	\label{tab:my-table}
\end{table}

\noindent
From table~\ref{tab:my-table} the ESP32 s2-mini is power efficient, contains enough expandability to implement the necessary sensors, has wireless capabilities and is more affordable than the alternatives.


\subsection{ESPNow/WiFi}
When considering data transfer between the basestation and satellite station, speed, power consumption and range need to be accounted for.
According to an article done by Dani Eichhorn from thingpulse, the runtime of a typical ESP32 running on a standard $ 2.5\si{\ampere\hour} $ battery
can be increased from an estimated 6.9 months on a WiFi gateway to up to 3.7 years on esp-NOW, a sixfold increase \cite{wifiespnow}.
\begin{figure}[!htb]
	\centering
	\includegraphics[width=0.35\linewidth]{body/fig/Comparative_Performance_Study_of_ESP-NOW_Wi-Fi_Bluetooth_Protocols_based_on_Range_Transmission_Speed_Latency_Energy_Usage_and_Barrier_Resistance}
	\caption{Overall Performance of each Protocol}
	\label{fig:cmp}
\end{figure}

\noindent
In figure~\ref{fig:cmp} extracted from a study done regarding the performance of the various wireless aspects of the esp32\cite{esprange} it can be seen that the transmission range of esp-NOW is superior to that of WiFi making it a valid option for transmission, while also keeping power consumption low. Tests will have to be done to see if the transmission speeds are fast enough to enable transmission of data when the satellite station reaches base.


\subsection{Sensors}
\subsubsection{$\mathrm{CO_2}$}
For the $\mathrm{CO_2}$ sensor a sensor with at least 5000ppm measuring capability was needed, as that was the top end of exposure for AQI. It also needed a suitable interface and an acceptable power consumption and fast enough response time.
After looking at a few options on the market, the Senseair K30 FR(Fast response) NDIR sensor was chosen. This sensor features both UART and I2C communication, has a 70mA average power consumption when powered, has a 0-5000ppm sensing capability and is a fast response sensor, meaning it does not need a fan and can the fan from the other sensor is plenty to provide the diffusion needed to enable accurate and fast sensing.
% why was it chosen
\subsubsection{PM, $\mathrm{NO_x}$, VOC}
The sensor chosen for the various needed values needed to comply to the various parameters needed to determine air quality. For the air quality index, the values indicated are VOC and PM2.5, these values needed to have a range of at least 100-700 $ \si{\micro\gram}/\si{\centi\meter^3} $ and 0-1200  $ \si{\micro\gram}/\si{\centi\meter^3} $ respectively.

\noindent
The sensor chosen is an all in one sensor, the Sensirion SEN55, it measures Temperature, Humidity, Particulate matter in the ranges 1, 2.5, 4, and 10 \si{\micro\meter}
Both the VOC and NOx values are given as an index from a given baseline, so the information gathered from it wil be in the form of a qualitative measurement based on what would be considered to be normal values, any deviation from the baseline represents a change in air quality. The particulate matter is given in precise measurements, so that will be helpful to identify the possible types of pollutants as well.


% \usepackage{graphicx}
% \usepackage{multirow}
% \usepackage{booktabs}
% \usepackage{colortbl}


\begin{table}[!htb]
	\centering
	\setlength{\extrarowheight}{0pt}
	\addtolength{\extrarowheight}{\aboverulesep}
	\addtolength{\extrarowheight}{\belowrulesep}
	\setlength{\aboverulesep}{0pt}
	\setlength{\belowrulesep}{0pt}

	\resizebox{\linewidth}{!}{%
		\begin{tabular}{|l|l|l|l|l|} 
			\toprule
			\rowcolor[rgb]{0.749,0.749,0.749} \multicolumn{1}{|l}{Parameter} & \multicolumn{1}{l}{Conditions} & \multicolumn{1}{l}{} & \multicolumn{1}{l}{Value} & Units \\ 
			\midrule
			Mass concentration specified range & \multicolumn{2}{l|}{-} & 0 to 1000 & ug/m3 \\ 
			\midrule
			\multirow{4}{*}{Mass concentration size range} & \multicolumn{2}{l|}{PM1.0} & 0.3 to 1.0 & um \\ 
			\cmidrule(lr){2-5}
			& \multicolumn{2}{l|}{PM2 5} & 0.3 to 2.5 & um \\ 
			\cmidrule(lr){2-5}
			& \multicolumn{2}{l|}{PM4} & 0.3 to 4.0 & um \\ 
			\cmidrule(lr){2-5}
			& \multicolumn{2}{l|}{PM10} & 0.3 to 10.0 & um \\ 
			\midrule
			\multirow{2}{*}{Mass concentration precision for   PM1 and PM2.5} & \multicolumn{2}{l|}{0 to 100 ug/m3} & ±5 ug/m3 AND 5 \% m.v. &  \\ 
			\cmidrule(lr){2-5}
			& \multicolumn{2}{l|}{100 to 1000 ug/m3} & ±10 & \% m.v. \\ 
			\midrule
			\multirow{2}{*}{Mass concentration precision2,3   for PW, PM105} & \multicolumn{2}{l|}{0 to 100 ug/m3} & ±25 & ug/m3 \\ 
			\cmidrule(lr){2-5}
			& \multicolumn{2}{l|}{100 to 1000 ug/m3} & ±25 & \% m.v. \\ 
			\midrule
			\multirow{2}{*}{Maximum long-term mass   concentration precision limit drift} & \multicolumn{2}{l|}{0 to 100 ug/m3} & ±1 25 & ug/m3 / year \\ 
			\cmidrule(lr){2-5}
			& \multicolumn{2}{l|}{100 to 1000 ug/m3} & ±1 25 & \% m.v. / year \\ 
			\midrule
			\multirow{3}{*}{Typical start-up time} & \multirow{3}{*}{number concentration} & 200 - 3000 \#/cm3 & 8 & s \\ 
			\cmidrule(lr){3-5}
			&  & 100 -200 \#/cm3 & 16 & s \\ 
			\cmidrule(lr){3-5}
			&  & 50 — 100 \#/cm3 & 30 & s \\ 
			\midrule
			Sensor output characteristics & \multicolumn{2}{l|}{PM2.5 mass concentration} & \multicolumn{2}{l|}{Calibrated to TSI DustTrak\{TM\} DRX   8533 Ambient Mode} \\ 
			\midrule
			Additional T-dependent mass   precision limit drift & temperature difference to 25C & typ. & ±05 & \% m.v./ oc \\ 
			\midrule
			Laser wavelength (DIN EN 60825-1   Class 1) & \multicolumn{2}{l}{typ} & 660 & nm \\
			\bottomrule
		\end{tabular}
	}
	\caption{Particulate matter sensor specifications \cite{sen55}}
	\label{tab:prtmat}
\end{table}


\noindent As seen in table~\ref{tab:prtmat} \cite{sen55} the precision attained is more than adequate for our measuring purposes.


\definecolor{Silver}{rgb}{0.752,0.752,0.752}
\begin{table}[!htb]
	\centering

	\resizebox{\linewidth}{!}{%
		\begin{tblr}{
				row{1} = {Silver},
				cell{2}{1} = {r=14}{c},
				cell{2}{2} = {r=3}{},
				cell{2}{4} = {c},
				cell{2}{7} = {r=14}{},
				cell{3}{4} = {c},
				cell{4}{4} = {c},
				cell{5}{2} = {r=3}{},
				cell{5}{4} = {c},
				cell{6}{4} = {c},
				cell{7}{4} = {c},
				cell{8}{2} = {r=2}{},
				cell{8}{4} = {c},
				cell{9}{4} = {c},
				cell{10}{2} = {r=3}{},
				cell{10}{4} = {c},
				cell{11}{4} = {c},
				cell{12}{4} = {c},
				cell{13}{2} = {r=3}{},
				cell{13}{4} = {c},
				cell{14}{4} = {c},
				cell{15}{4} = {c},
				vlines,
				hline{1,16} = {-}{0.08em},
				hline{2} = {-}{0.05em},
				hline{3-4,6-7,9,11-12,14-15} = {3}{l},
				hline{3-4,6-7,9,11-12,14-15} = {4-5}{},
				hline{3-15} = {6}{r},
				hline{5,8,10,13} = {2}{l},
				hline{5,8,10,13} = {3-5}{},
			}
			Parameter & Conditions &  & Min & Typ & Max & Unit\\
			Average supply current & Idle Mode (first 10 seconds) & SEN55 & - & 3.8 & 4.2 & mA\\
			&  & SEN54 & - & 7 & 1 & \\
			&  & SEN50 & - & 0.7 & 1 & \\
			& Idle Mode (after first 10 seconds) & SEN55 & - & 2.6 & 3 & \\
			&  & SEN54 & - & 0.7 & 1 & \\
			&  & SEN50 & - & 0.7 & 1 & \\
			& RHT/Gas-only Measurement Mode & SEN55 & - & 6.8 & 8 & \\
			&  & SEN54 & - & 6.5 & 7.7 & \\
			& Measurement-Mode (first 60   seconds) & SEN55 & - & 70 & 100 & \\
			&  & SEN54 & - & 70 & 100 & \\
			&  & SEN50 & - & 70 & 100 & \\
			& Measurement-Mode   (after first 60 seconds) & SEN55 & - & 63 & 80 & \\
			&  & SEN54 & - & 63 & 80 & \\
			&  & SEN50 & - & 63 & 80 & 
		\end{tblr}
	}
	\caption{Current draw \cite{sen55}}
	\label{tab:powercons}
\end{table}

\noindent Table~\ref{tab:powercons} \cite{sen55} contains the power requirements for all of these sensors, with the average being 63mA at 5V for typical use.

\subsection{Power}
From the previous section the power usage on average was found to be $ 70 +  63 = 133\si{\milli\ampere}$ consumption for the sensors alone. Depending on the draw from the ESP32 the consumption total would average around $ 70 +  63 + 90 = 223\si{\milli\ampere}$\cite{wifiespnow}. 

\noindent
For the intended use, remote data gathering would be done with the help of a lithium battery pack, as lithium ion /polymer batteries are energy dense and are commonly found in USB power banks. Most of the sensors and the microcontroller either have native 5V input or have a voltage regulator onboard making it ideal. To calculate the size of the battery necessary, we take the typical usage, in the case of inside the taxi being 3 hours for the morning commutes and in the case of the base station 14 hours for the full day data. This gives: $223\si{\milli\ampere} \times 14 = 3.122 \si{\ampere\hour} $ at 5V. This equates to $15.61 \si{\watt\hour}$. Typically battery bank capacity is given in $ \si{\milli\amphour} $ but this can be deceiving as it normally references the capacity of the cells in parallel with an average voltage of 3.7V not the 5V output. With the $15.61 \si{\watthour}$ needed, this would equate to a  $ 4218,9\si{\milli\amphour} $ Power bank needed. To ensure Full day usage, a typical power bank of 10000$ \si{\milli\amphour} $ is chosen. This also ensures that, should the system need to, it would be able to provide 24 hour data.


\section{Metrics}
%Does the sensor actually work...
%Does it work as wanted
%Experimental setup