\chapter{Detailed System Design}
\vspace{-2em}
\section{Hardware}


This system consists of multiple interconnecting components that will be discussed in detail in this section, namely:
\begin{itemize}
	\item ESP32-S2
	\item Sensiron Sen55
	\item Sensair K30
	\item SD-card adapter
	\item ATGM336H GPS module
	\item Power bank	
\end{itemize} 




\subsection{ESP32-S2}

\begin{figure}[!htb]
	\centering
	\includegraphics[width=0.4\linewidth]{body/fig/s2_mini}
	\caption{ESP32-S2 mini}
	\label{fig:s2mini}
\end{figure}


\noindent
The module used is the ESP32-S2 mini by WEMOS/Lolin. This module features thirty seven digital pins, three SPI interfaces with two of them fully available, two i2c buses, dual hardware UARTs, a built-in WiFi radio with antenna on board. The board runs on 3.3v power, but has an onboard voltage regulator that works on 5V\cite{wemos2021s2mini}. Although the board supports multiple i2c devices, it was chosen to connect both devices to one bus since they have different addresses. This also alleviates some space in memory by not having another initialisation of the i2c library instance.
%The ESP32-S2 is capable of multiple STA and AP modes, including simultaneous broadcasting over ESP-NOW and WiFi. This is needed to be able to have the 2 ESP boards communicate and the base station be able to send the data to a database.
\subsubsection{SD - interface}
The SD card interface was done using SPI. The module was hard soldered to a micro SD to SD card adapter. These pins were then soldered to the ESP32's SPI and 3.3V pins.
The FS, SD and SPI libraries from Espresiff were used to interface with the already formatted micro SD card.




\subsection{Sensors}
\subsubsection{$\mathrm{CO_2}$}
{\color{red} \huge Insert docs you made while working with them}

% why was it chosen


\subsubsection{PM, $\mathrm{NO_x}$, VOC, Temperature, Humidity}
\noindent
The main ESP referenced as the Base station, will be connected periodically to the internet to send the data it collects to the database of choice. 

\subsection{GPS}

\pagebreak
\subsection{Software/Firmware implementation}
\subsubsection{Overview}
%{\color{red} \huge Insert flowchart}

\begin{figure}[!htb]
	\centering
	\includegraphics[width=\textwidth]{body/fig/flowchart.drawio.png}
	\caption{Flow diagram of software implementation }
	\label{fig:softwareoverview}
\end{figure}

\subsection{UART}
The GPS unit uses UART Serial commands to send its data to the ESP32. The data received from the GPS module is in the format of NMEA strings. This is the standard format for most gps receivers.\cite{NMEA}
\begin{table}[!htb]
	\resizebox{\textwidth}{!}{%
		\begin{tabular}{|l|l|}
			\hline
			NMEA Sentence & Meaning \\ \hline
			GPGGA & Global positioning system fix data (time, position, fix type data) \\ \hline
			GPGLL & Geographic position, latitude, longitude \\ \hline
			GPVTG & Course and speed information relative to the ground \\ \hline
			GPRMC & Time, date, position, course and speed data \\ \hline
			GPGSA & GPS receiver operating mode, satellites used in the position solution, and DOP values. \\ \hline
			GPGSV & The number of GPS satellites in view satellite ID numbers, elevation, azimuth and SNR values. \\ \hline
			GPMSS & Signal to noise ratio, signal strength, frequency, and bit rate from a radio beacon receiver. \\ \hline
			GPTRF & Transit fix data \\ \hline
			GPSTN & Multiple data ID \\ \hline
			GPXTE & cross track error, measured \\ \hline
			GPZDA & Date and time (PPS timing message, synchronized to PPS). \\ \hline
			150 & OK to send message. \\ \hline
		\end{tabular}%
	}
	\label{tab:nmea}
	\caption{NMEA Sentences and their meanings \cite{GPSSentence}}
\end{table}

\noindent
This data is sent over the uart in comma delimited messages, the uart is set to default to 9600 baud.
The ESP32-S2 has 2 hardware UARTs, one is used for debugging and communication with the device while developing and one for communicating with the GPS module. The first UART is set to 115200 baud and the second to 9600 baud. Each UART is initialized separately and the second UART is passed to the gps encoding library TinyGPS++. The first UART is only called when debugging or notices are needed. It is used to check sending of messages using ESP-NOW for example.


\subsection{i2c}
Both the Sensirion and Senseair sensors make use of the i2c bus to communicate. 

\subsection{ESP-NOW}



